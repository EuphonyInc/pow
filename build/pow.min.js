angular.module("pow",[]),function(){"use strict";angular.module("pow").directive("powPlayer",function(a,b){return{restrict:"E",templateUrl:"player.html",replace:!0,link:function(b,c,d,e){function f(a){this.ac=new(window.AudioContext||webkitAudioContext),this.url=g,this.el=a,this.button=a.children()[1].children[0],this.downloadButton=a.children()[1].children[2],this.track=a.children()[1].children[1],this.progress=a.children()[1].children[1].children[0],this.scrubber=a.children()[1].children[1].children[1],this.message=a.children()[0],this.loading=!0,this.message.innerHTML="Loading",this.bindEvents()}b.$watch(d.arrayBuffer,function(a){window.player.fetch(a)},!0),f.prototype.bindEvents=function(){this.downloadButton.addEventListener("click",this.download.bind(this)),this.button.addEventListener("click",this.toggle.bind(this)),this.scrubber.addEventListener("mousedown",this.onMouseDown.bind(this)),window.addEventListener("mousemove",this.onDrag.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this))},f.prototype.fetch=function(a){a&&(this.loading=!0,this.decode(a))},f.prototype.decode=function(b){this.ac.decodeAudioData(b,function(b){this.message.innerHTML="Loaded",this.buffer=b,this.wav=a.audioBufferToWav(b),this.draw(),this.loading=!1}.bind(this))},f.prototype.connect=function(){this.playing&&this.pause(),this.source=this.ac.createBufferSource(),this.source.buffer=this.buffer,this.source.connect(this.ac.destination)},f.prototype.play=function(a){this.connect(),this.position="number"==typeof a?a:this.position||0,this.startTime=this.ac.currentTime-(this.position||0),this.source.start(this.ac.currentTime,this.position),this.playing=!0},f.prototype.pause=function(){this.source&&(this.source.stop(0),this.source=null,this.position=this.ac.currentTime-this.startTime,this.playing=!1)},f.prototype.seek=function(a){this.playing?this.play(a):this.position=a},f.prototype.updatePosition=function(){return this.position=this.playing?this.ac.currentTime-this.startTime:this.position,this.position>=this.buffer.duration&&(this.position=this.buffer.duration,this.pause()),this.position},f.prototype.toggle=function(){this.playing?this.pause():this.play()},f.prototype.download=function(){if(!this.loading){var a=document.createElement("a");document.body.appendChild(a),a.style="display: none";var b=new window.Blob([new DataView(this.wav)],{type:"audio/wav"}),c=window.URL.createObjectURL(b);a.href=c,a.download="audio.wav",a.click(),window.URL.revokeObjectURL(c)}},f.prototype.onMouseDown=function(a){this.dragging=!0,this.startX=a.pageX,this.startLeft=parseInt(this.scrubber.style.left||0,10)},f.prototype.onDrag=function(a){var b,c;this.dragging&&(b=this.track.offsetWidth,c=this.startLeft+(a.pageX-this.startX),c=Math.max(Math.min(b,c),0),this.scrubber.style.left=c+"px")},f.prototype.onMouseUp=function(){var a,b,c;this.dragging&&(a=this.track.offsetWidth,b=parseInt(this.scrubber.style.left||0,10),c=b/a*this.buffer.duration,this.seek(c),this.dragging=!1)},f.prototype.draw=function(){var a=this.updatePosition()/this.buffer.duration,b=this.track.offsetWidth;this.playing?(this.button.classList.add("fa-pause"),this.button.classList.remove("fa-play")):(this.button.classList.add("fa-play"),this.button.classList.remove("fa-pause")),this.progress.style.width=a*b+"px",this.dragging||(this.scrubber.style.left=a*b+"px"),requestAnimationFrame(this.draw.bind(this))};var g="http://static.kevvv.in/sounds/callmemaybe.mp3";window.player=new f(c)}}})}(),function(){"use strict";angular.module("pow").factory("$pow",function(){function a(a,b,f,g,h){var i=h/8,j=g*i,k=new ArrayBuffer(44+a.length*i),l=new DataView(k);return e(l,0,"RIFF"),l.setUint32(4,36+a.length*i,!0),e(l,8,"WAVE"),e(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,b,!0),l.setUint16(22,g,!0),l.setUint32(24,f,!0),l.setUint32(28,f*j,!0),l.setUint16(32,j,!0),l.setUint16(34,h,!0),e(l,36,"data"),l.setUint32(40,a.length*i,!0),1===b?d(l,44,a):c(l,44,a),k}function b(a,b){for(var c=a.length+b.length,d=new Float32Array(c),e=0,f=0;e<c;)d[e++]=a[f],d[e++]=b[f],f++;return d}function c(a,b,c){for(var d=0;d<c.length;d++,b+=4)a.setFloat32(b,c[d],!0)}function d(a,b,c){for(var d=0;d<c.length;d++,b+=2){var e=Math.max(-1,Math.min(1,c[d]));a.setInt16(b,e<0?32768*e:32767*e,!0)}}function e(a,b,c){for(var d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))}return{audioBufferToWav:function(c,d){d=d||{};var e,f=c.numberOfChannels,g=c.sampleRate,h=d.float32?3:1,i=3===h?32:16;return e=2===f?b(c.getChannelData(0),c.getChannelData(1)):c.getChannelData(0),a(e,h,g,f,i)}}})}();